service: gemini-railway-app

provider:
  name: aws
  runtime: python3.9
  region: us-east-1
  stage: ${opt:stage, 'dev'}
  environment:
    STAGE: ${self:provider.stage}
    S3_BUCKET_NAME: ${self:service}-${self:provider.stage}-receipts
    DYNAMODB_TABLE_BOOKINGS: ${self:service}-${self:provider.stage}-bookings
    DYNAMODB_TABLE_TRAINS: ${self:service}-${self:provider.stage}-trains
    DYNAMODB_TABLE_USERS: ${self:service}-${self:provider.stage}-users

functions:
  app:
    handler: app.lambda_handler
    events:
      - http:
          path: /{proxy+}
          method: ANY
          cors: true
      - http:
          path: /
          method: ANY
          cors: true

resources:
  Resources:
    # S3 Bucket for receipt storage
    ReceiptsBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:provider.environment.S3_BUCKET_NAME}
        CorsConfiguration:
          CorsRules:
            - AllowedHeaders:
                - "*"
              AllowedMethods:
                - GET
                - PUT
                - POST
                - DELETE
                - HEAD
              AllowedOrigins:
                - "*"
              ExposedHeaders:
                - ETag

    # DynamoDB Table for bookings
    BookingsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.DYNAMODB_TABLE_BOOKINGS}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: BookingID
            AttributeType: S
          - AttributeName: UserID
            AttributeType: S
        KeySchema:
          - AttributeName: BookingID
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: UserIdIndex
            KeySchema:
              - AttributeName: UserID
                KeyType: HASH
            Projection:
              ProjectionType: ALL

    # DynamoDB Table for users
    UsersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.DYNAMODB_TABLE_USERS}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: UserID
            AttributeType: S
          - AttributeName: UsernameLower
            AttributeType: S
          - AttributeName: EmailLower
            AttributeType: S
        KeySchema:
          - AttributeName: UserID
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: UsernameLowerIndex
            KeySchema:
              - AttributeName: UsernameLower
                KeyType: HASH
            Projection:
              ProjectionType: ALL
          - IndexName: EmailLowerIndex
            KeySchema:
              - AttributeName: EmailLower
                KeyType: HASH
            Projection:
              ProjectionType: ALL

    # DynamoDB Table for trains
    TrainsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:provider.environment.DYNAMODB_TABLE_TRAINS}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: TrainID
            AttributeType: S
        KeySchema:
          - AttributeName: TrainID
            KeyType: HASH

    # S3 Bucket Policy
    ReceiptsBucketPolicy:
      Type: AWS::S3::BucketPolicy
      Properties:
        Bucket: !Ref ReceiptsBucket
        PolicyDocument:
          Statement:
            - Effect: Allow
              Principal: "*"
              Action:
                - s3:GetObject
                - s3:PutObject
              Resource: !Sub "${ReceiptsBucket}/*"